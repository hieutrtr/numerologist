# Story 1.5: Basic Voice-Numerology Integration Flow

## Status
Draft

## Story
As a user,
I want to have a complete voice conversation that collects my information and provides numerology insights,
so that I can experience the core value proposition of the Numeroly voicebot.

## Context
This story integrates the three completed technical foundations (Voice Input from Story 1.2, Voice Output from Story 1.3, and Numerology Engine from Story 1.4) into a cohesive user experience. Users will have their first complete interaction with Numeroly: speaking their name and birthdate, receiving calculations, and hearing personalized numerology insights via voice.

**Epic:** 1 - Foundation & Core Voice Infrastructure
**Priority:** P0 - Blocking (enables all future stories)
**Story Points:** 13
**Depends On:** Story 1.2 (STT), Story 1.3 (TTS), Story 1.4 (Numerology Engine) - ALL COMPLETE ✅
**Enables:** Story 2.1 (User Profiles), Story 2.2 (Conversation Context), Story 3.1 (History/Journal)

## Acceptance Criteria

1. **Onboarding Voice Flow Collecting User Information**
   - Voicebot greets user with warm Vietnamese welcome message via voice
   - User can provide name through voice input with automatic transcription
   - User can provide birth date (day/month/year) through voice input with parsing
   - System confirms collected information before proceeding
   - Input validation with Vietnamese error messages for invalid dates
   - User can correct information and try again if needed

2. **Voice Interaction Flow Asking for User's Concern**
   - After information collection, system asks primary question via voice: "Hiện tại bạn muốn biết điều gì về bản thân?" (What would you like to know about yourself?)
   - User responds with their question/concern through voice input
   - System transcribes and stores the user's concern
   - System can handle follow-up questions if user's response is vague
   - Conversation context maintained throughout exchange

3. **Integration Between Voice Input, Numerology Calculations, and Voice Output**
   - System receives user's name and birth date
   - Backend calls numerology API to calculate Life Path, Destiny, Soul Urge, Personality numbers
   - Backend retrieves Vietnamese interpretations for each number
   - System generates response text combining numbers with user's concern
   - System synthesizes response to voice using TTS with warm tone
   - User hears complete numerology insight within 3 seconds of system processing

4. **Complete Conversation Delivering Numerology Insight via Voice**
   - System provides at least Life Path number insight customized to user's concern
   - Insight includes interpretation reflecting Pythagorean numerology meaning
   - Voice response connects user's personal situation with numerology insight
   - Response provides actionable guidance based on their number meaning
   - Total conversation provides value demonstrating core product concept

5. **Session Management Maintaining Context Across Voice Exchanges**
   - System tracks conversation session from greeting through insight delivery
   - User information (name, birthdate, concern) available throughout session
   - System can refer back to user's stated concern when providing insights
   - Session data available for retrieval in same device session
   - Session handling graceful for natural conversation flow

6. **Basic Conversation History Stored for User Reference**
   - Conversation details saved after session completion
   - Stored data includes: user name, birthdate, question asked, numbers calculated, insight provided, timestamp
   - User can view completed conversation in simple text summary format
   - History persists across app restarts (stored locally or in database)
   - Multiple conversations can be stored and accessed sequentially

7. **User Satisfaction Feedback Collection After Conversation Completion**
   - After insight delivery, system asks simple satisfaction question via voice
   - Options: "Hữu ích?" (Helpful?) with Yes/No voice response
   - System records feedback along with conversation
   - Simple 1-5 emoji rating alternative for user preference
   - Feedback used for identifying conversation quality issues

## Dev Notes

### Tech Stack Context
[Source: docs/architecture/tech-stack.md v1.1 - January 2025]
- **Frontend Language:** TypeScript 5.7 with React Native 0.76
- **State Management:** Zustand 5.0 (Story 1.4 already integrated)
- **Backend Language:** Python 3.13 with FastAPI 0.115
- **Voice Input:** Azure OpenAI gpt-4o-mini-transcribe (Story 1.2 integrated)
- **Voice Output:** ElevenLabs TTS with SSML tone (Story 1.3 integrated)
- **Numerology Engine:** Complete with Vietnamese interpretations (Story 1.4 integrated)

### Previous Stories Completed
[Source: Stories 1.1, 1.2, 1.3, 1.4 - All Approved ✅]
- **Story 1.1**: Backend infrastructure, PostgreSQL, FastAPI setup → COMPLETE
- **Story 1.2**: Voice input (STT) with Azure integration → COMPLETE
- **Story 1.3**: Voice output (TTS) with ElevenLabs → COMPLETE
- **Story 1.4**: Numerology calculations + interpretations → COMPLETE (37/37 tests passing)

**This story integrates all four completed components into first end-to-end user flow.**

### Frontend Architecture
[Source: docs/architecture/source-tree.md]
**New Screens to Create:**
- `apps/mobile/src/screens/OnboardingConversationScreen.tsx` - Main voice interaction screen
- `apps/mobile/src/components/conversation/ConversationFlowController.ts` - Orchestration logic

**Using Existing Components:**
- Voice button: `apps/mobile/src/components/voice/VoiceButton.tsx` (from Story 1.2)
- Waveform visualizer: `apps/mobile/src/components/voice/WaveformVisualizer.tsx` (from Story 1.2)
- Voice player: `apps/mobile/src/components/voice/AudioPlayer.tsx` (from Story 1.3)

**Using Existing Services:**
- Speech-to-text: `apps/mobile/src/services/speech-to-text.ts` (from Story 1.2)
- Text-to-speech: `apps/mobile/src/services/text-to-speech.ts` (from Story 1.3)
- Numerology API: `apps/mobile/src/services/numerology.ts` (from Story 1.4, with full tests)

**Using Existing State:**
- Zustand store: `apps/mobile/src/stores/userStore.ts` (from Story 1.4)
- Conversation store: `apps/mobile/src/stores/conversationStore.ts` (existing)

### Backend Architecture
[Source: docs/architecture.md - Conversation Management section]
**New Endpoint to Create:**
- `POST /api/v1/conversations/start` - Initialize conversation session
- `POST /api/v1/conversations/{id}/save` - Save conversation history

**Using Existing Endpoints:**
- `POST /api/v1/numerology/profile` - Calculate numerology (Story 1.4)
- `GET /api/v1/users/{id}` - Retrieve user info (Story 1.1)

**New Data Models:**
- `Conversation` table: id, user_id, question, numbers_calculated (JSON), insight_provided, timestamp, satisfaction_feedback
- Foreign key to User table, indexed on user_id and timestamp

### Conversation Flow Diagram

```
1. APP STARTS
   ↓
2. GREETING (TTS Output)
   System: "Chào mừng đến với Numeroly. Tên của bạn là gì?"
   (Hello, welcome to Numeroly. What is your name?)
   ↓
3. NAME INPUT (STT)
   User speaks: "Nguyễn Văn A"
   System transcribes: "Nguyễn Văn A" ✓
   ↓
4. CONFIRMATION (TTS Output)
   System: "Cảm ơn Nguyễn. Ngày sinh của bạn là gì? Vui lòng nói theo định dạng ngày tháng năm."
   (Thank you Nguyễn. What is your birth date? Please say in day/month/year format.)
   ↓
5. DATE INPUT (STT)
   User speaks: "15 tháng 3 năm 1990"
   System transcribes: "15 tháng 3 năm 1990" ✓
   System parses: 1990-03-15 ✓
   ↓
6. DATE CONFIRMATION (TTS Output)
   System: "Bạn sinh ngày 15 tháng 3 năm 1990, đúng không?"
   (You were born on March 15, 1990, correct?)
   ↓
7. CONCERN INPUT (STT)
   User speaks: "Tôi muốn biết về sự nghiệp và con đường phát triển của mình"
   System transcribes and stores concern
   ↓
8. NUMEROLOGY CALCULATION (Backend)
   Call: POST /api/v1/numerology/profile
   Request: { fullName: "Nguyễn Văn A", birthDate: "1990-03-15" }
   Response: { lifePathNumber: 3, destinyNumber: 7, soulUrgeNumber: 5, personalityNumber: 2, interpretations: {...} }
   ↓
9. INSIGHT GENERATION (Backend)
   Create response: "Số đường sống của bạn là 3. Bạn là một người sáng tạo có khả năng giao tiếp tốt. Trong sự nghiệp, bạn nên tìm công việc cho phép bạn thể hiện sáng tạo và tương tác với mọi người. Số định mệnh 7 cho thấy bạn có tư duy phân tích sâu..."
   ↓
10. VOICE OUTPUT (TTS)
    System synthesizes to voice with warm tone
    User hears complete insight in 2-3 seconds
    ↓
11. FEEDBACK COLLECTION (TTS/STT)
    System: "Bạn có thấy điều này hữu ích không?"
    (Did you find this helpful?)
    User responds: "Có, cảm ơn"
    ↓
12. CONVERSATION SAVED (Backend)
    Save to Conversation table:
    - conversation_id: uuid
    - user_id: uuid
    - user_name: "Nguyễn Văn A"
    - birth_date: "1990-03-15"
    - user_question: "Tôi muốn biết về sự nghiệp..."
    - numbers_calculated: {lifePathNumber: 3, destinyNumber: 7, ...}
    - insight_provided: "Số đường sống của bạn là 3..."
    - timestamp: 2025-01-16T10:45:00Z
    - satisfaction_feedback: "yes"
    ↓
13. GOODBYE (TTS Output)
    System: "Cảm ơn bạn. Hẹn gặp lại!"
    (Thank you. See you next time!)
```

### Error Handling & Vietnamese Messages

**Birth Date Validation Errors:**
- "Ngày sinh không hợp lệ. Vui lòng thử lại với định dạng đúng." (Invalid birth date. Please try again with correct format.)
- "Ngày sinh phải trong quá khứ. Vui lòng kiểm tra lại." (Birth date must be in the past. Please check.)
- "Ngày sinh phải sau năm 1900. Vui lòng kiểm tra lại." (Birth date must be after 1900. Please check.)

**Name Validation Errors:**
- "Tên không được để trống. Vui lòng nói tên của bạn." (Name cannot be empty. Please say your name.)
- "Tên quá dài. Vui lòng nói tên ngắn hơn." (Name too long. Please say a shorter name.)

**Voice Input Errors:**
- "Xin lỗi, tôi không nghe rõ. Vui lòng nói lại." (Sorry, I didn't hear clearly. Please try again.)
- "Vấn đề với kết nối mạng. Vui lòng kiểm tra kết nối." (Network connection issue. Please check your connection.)

**API Errors:**
- "Có lỗi khi tính toán. Vui lòng thử lại sau." (Error during calculation. Please try again later.)
- "Dịch vụ tạm thời không khả dụng. Vui lòng thử lại." (Service temporarily unavailable. Please try again.)

### Session Management

**Session Storage:**
- Use Zustand store for active conversation state (name, birthdate, concern)
- Use local database (SQLite or Realm) for session persistence
- Clear session after save or user logout

**Session Recovery:**
- If app crashes during conversation, show option to resume
- Restore state from last known conversation point
- Allow user to restart if recovery not desired

### Testing Approach
[Source: docs/architecture/coding-standards.md - Testing Strategy]

**Frontend Integration Tests:**
- Test voice input collecting name (with various Vietnamese name formats)
- Test voice input collecting birth date (with various date formats)
- Test numerology API call and response handling
- Test TTS output with response
- Test feedback collection
- Test conversation save to local storage

**Backend Integration Tests:**
- Test conversation save endpoint
- Test with various date formats (numeric, text, with/without Vietnamese month names)
- Test conversation retrieval
- Test with invalid data (missing fields, wrong types)

**E2E/Manual Testing:**
- Full conversation flow from greeting to feedback
- Vietnamese voice clarity and recognition
- TTS quality and warmth
- Real user reactions to numerology insight

### Performance Considerations
[Source: docs/architecture.md - Performance Requirements]

**Response Time Targets:**
- STT transcription: <2 seconds
- Numerology calculation: <500ms
- TTS synthesis: <1.5 seconds
- Total voice response: <3 seconds (all three combined)

**Optimization Strategy:**
- Cache numerology calculations in memory if same profile requested
- Parallel processing: start TTS while saving conversation data
- Compress conversation history to reduce storage

## Tasks / Subtasks

- [ ] **Task 1: Frontend Conversation Flow Controller** (AC: 1-7)
  - [ ] Create `ConversationFlowController.ts` orchestrating conversation states
  - [ ] Implement state machine for: greeting → name input → date input → concern input → calculation → insight → feedback → save
  - [ ] Define conversation state interface with current user info, collected data, current step
  - [ ] Handle transitions between steps with validation
  - [ ] Implement error recovery logic (retry on invalid input)
  - [ ] Add timeout handling for each voice interaction step
  - [ ] Test state transitions with various input scenarios

- [ ] **Task 2: Onboarding Voice Greeting Screen** (AC: 1, 5)
  - [ ] Create `OnboardingConversationScreen.tsx` component
  - [ ] Implement welcome greeting logic (TTS output)
  - [ ] Add name collection flow (prompt → voice input → transcription)
  - [ ] Add name confirmation step with retry capability
  - [ ] Implement visual feedback during voice input (waveform display)
  - [ ] Test Vietnamese name recognition accuracy

- [ ] **Task 3: Birth Date Collection & Parsing** (AC: 1, 5)
  - [ ] Implement birth date prompt (TTS output)
  - [ ] Create voice input for date collection
  - [ ] Implement date parsing from Vietnamese text (e.g., "15 tháng 3 năm 1990")
  - [ ] Add numeric format parsing (15/3/1990, 15-03-1990)
  - [ ] Add date validation (range 1900-today, valid day/month)
  - [ ] Implement confirmation with user feedback loop
  - [ ] Generate and output confirmation message via TTS

- [ ] **Task 4: User Concern Collection** (AC: 2, 5)
  - [ ] Implement primary question prompt (TTS output)
  - [ ] Add voice input for user's concern/question
  - [ ] Store user's question for use in insight generation
  - [ ] Implement follow-up logic if initial response too vague
  - [ ] Test various concern types (career, relationships, personal growth)

- [ ] **Task 5: Integration with Numerology API** (AC: 3, 4)
  - [ ] Call numerology service endpoint with collected name and birthdate
  - [ ] Handle API response with calculated numbers and interpretations
  - [ ] Implement error handling for API failures
  - [ ] Add retry logic with exponential backoff
  - [ ] Implement timeout handling (3-second max wait)
  - [ ] Test with various numerology profiles (including Master Numbers)

- [ ] **Task 6: Insight Generation & Personalization** (AC: 3, 4)
  - [ ] Create insight text generation combining numerology numbers with user's concern
  - [ ] Generate response incorporating Life Path interpretation
  - [ ] Add personalization based on user's stated question/concern
  - [ ] Create actionable guidance within insight
  - [ ] Implement fallback insight for edge cases
  - [ ] Test response quality with various concern types

- [ ] **Task 7: Voice Output Integration** (AC: 3, 4)
  - [ ] Integrate TTS service for insight delivery
  - [ ] Synthesize generated insight text to Vietnamese voice
  - [ ] Apply warm tone modulation via SSML/ElevenLabs settings
  - [ ] Implement audio playback with user controls (pause, replay, volume)
  - [ ] Handle TTS failures with text fallback
  - [ ] Verify response latency <3 seconds total

- [ ] **Task 8: User Feedback Collection** (AC: 7)
  - [ ] Implement feedback prompt (TTS output)
  - [ ] Add voice input for yes/no responses
  - [ ] Implement alternative 1-5 emoji rating (optional)
  - [ ] Store feedback with conversation data
  - [ ] Handle feedback input timeout gracefully

- [ ] **Task 9: Conversation History & Storage** (AC: 6)
  - [ ] Create `Conversation` database table schema
  - [ ] Implement conversation save endpoint: `POST /api/v1/conversations`
  - [ ] Store all conversation data: user info, numbers, insight, feedback, timestamp
  - [ ] Implement local device storage as fallback
  - [ ] Add conversation retrieval endpoint: `GET /api/v1/conversations/{id}`
  - [ ] Implement conversation listing for user history

- [ ] **Task 10: Session Management & Context** (AC: 5, 6)
  - [ ] Implement session creation on conversation start
  - [ ] Maintain session state throughout conversation lifecycle
  - [ ] Store session in Zustand store for React component access
  - [ ] Add session persistence to local database
  - [ ] Implement session recovery on app restart
  - [ ] Handle session cleanup after save or user logout
  - [ ] Test multi-turn conversation with context maintained

- [ ] **Task 11: Complete Integration Testing** (AC: 1-7)
  - [ ] Create end-to-end test scenarios (story mode)
  - [ ] Test with various Vietnamese names and date formats
  - [ ] Test error scenarios (invalid input, network failure, timeouts)
  - [ ] Test conversation save and retrieval
  - [ ] Verify all voice interactions flow smoothly
  - [ ] Test with real voice input (manual testing)
  - [ ] Performance validation (response time <3 seconds)

- [ ] **Task 12: UI Polish & User Experience** (AC: 1, 5, 7)
  - [ ] Add visual feedback for voice recording (animated waveform)
  - [ ] Implement transcript display showing what system heard
  - [ ] Add ability to correct transcriptions before proceeding
  - [ ] Implement progress indicator showing conversation step (3/5)
  - [ ] Add subtle animations for conversation transitions
  - [ ] Implement loading states during API calls
  - [ ] Test on various device sizes and screen orientations

## Testing Strategy

**Unit Tests:**
- Conversation flow state machine transitions
- Date parsing logic with various Vietnamese formats
- Insight generation with different numerology combinations
- Error handling for all error types

**Integration Tests:**
- End-to-end conversation flow from greeting to feedback
- API calls for numerology and conversation save
- TTS and STT service integration
- Local storage persistence

**Manual Testing:**
- Vietnamese voice input recognition accuracy
- TTS voice quality and warmth perception
- Real conversation naturalness and flow
- User feedback on numerology insight relevance
- Performance timing validation

**Test Data:**
- Vietnamese names: Nguyễn Văn A, Trần Thị B, Phạm Văn C (simple to complex)
- Birth dates: Various formats (15/3/1990, 15 tháng 3 năm 1990, 1990-03-15)
- Master Number profiles: Birth dates producing 11, 22, 33
- Edge cases: Single character names, leap years, very old/young dates

## Acceptance Criteria Mapping

| AC | Related Tasks |
|---|---|
| 1. Onboarding voice flow | Tasks 2, 3, 12 |
| 2. Voice interaction for concern | Task 4 |
| 3. Integration of input/calc/output | Tasks 5, 6, 7 |
| 4. Complete conversation & insight | Tasks 6, 7 |
| 5. Session management | Task 10 |
| 6. Conversation history | Task 9 |
| 7. Feedback collection | Task 8 |

## Project Structure Notes

**New Files to Create:**
- `apps/mobile/src/screens/OnboardingConversationScreen.tsx` - Main screen component
- `apps/mobile/src/components/conversation/ConversationFlowController.ts` - State orchestration
- `apps/api/src/models/conversation.py` - Conversation ORM model
- `apps/api/src/routes/conversations.py` - Conversation endpoints
- `apps/api/src/schemas/conversation.py` - Request/response schemas

**Existing Files to Use (Already Completed):**
- `apps/mobile/src/services/speech-to-text.ts` (Story 1.2) ✅
- `apps/mobile/src/services/text-to-speech.ts` (Story 1.3) ✅
- `apps/mobile/src/services/numerology.ts` (Story 1.4) ✅
- `apps/mobile/src/stores/userStore.ts` (Story 1.4) ✅
- `apps/api/src/routes/numerology.py` (Story 1.4) ✅

**Database Migrations:**
- Create Conversation table with proper schema
- Add indexes on user_id and created_at for efficient querying

## File List

**Files to be Created (Tasks 1-12):**
- [ ] `apps/mobile/src/screens/OnboardingConversationScreen.tsx` - Main conversation screen (350-400 lines)
- [ ] `apps/mobile/src/components/conversation/ConversationFlowController.ts` - Flow orchestration (250-300 lines)
- [ ] `apps/api/src/models/conversation.py` - ORM model with Conversation table definition
- [ ] `apps/api/src/schemas/conversation.py` - Pydantic request/response schemas
- [ ] `apps/api/src/routes/conversations.py` - API endpoints (save, retrieve, list)
- [ ] `apps/api/alembic/versions/xxx_create_conversation_table.py` - Database migration
- [ ] `apps/mobile/src/__tests__/screens/OnboardingConversationScreen.test.ts` - Screen tests (400+ lines)
- [ ] `apps/api/src/__tests__/test_conversation_endpoints.py` - Endpoint tests (300+ lines)

**Files to be Modified:**
- [ ] `apps/mobile/src/navigation/RootNavigator.tsx` - Add OnboardingConversationScreen route
- [ ] `apps/api/src/main.py` - Register conversation routes

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-16 | 1.0 | Initial story creation for Story 1.5 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
To be filled by developer during implementation

### Debug Log References
To be filled by developer with test results and validation outputs

### Completion Notes List
To be filled by developer upon task completion

### File List (To be updated during implementation)
Pending implementation

---

**Status:** Draft - Ready for developer review and implementation planning

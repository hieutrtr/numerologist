# Story 1.2b - Dependency & Import Stabilization Review

**Story ID:** 1.2b  
**Epic:** Epic 1: Foundation & Core Voice Infrastructure  
**Status:** Draft  
**Story Points:** 3 (audit & planning)  
**Priority:** High (blocks reliable mobile builds)

---

## Story

As a development lead,
I want a clear audit of the mobile frontend’s dependencies and import assumptions,
so that future voice feature work isn’t blocked by missing packages, hoisted modules, or brittle import paths.

---

## Context & Problem Statement

Story 1.2a surfaced several bundling issues: missing `axios`, `react-refresh`, `@babel/runtime`, and hoisting quirks that broke Expo’s module resolution. To avoid repeated breakages during implementation, we need a formal pass cataloguing required dependencies, aligning versions across workspaces, and documenting best practices for future imports.

---

## Acceptance Criteria

1. **Dependency Inventory**  
   - Produce a definitive list of runtime and dev dependencies required by `apps/mobile` and shared UI packages.  
   - Identify packages expected at the workspace root vs. local `node_modules` and document when symlinks/hoisting is acceptable.  
   - Flag any version mismatches (e.g., React 19 in mobile vs React 18 in shared UI).

2. **Import Health Report**  
   - Scan source files for unresolved imports, deprecated modules, or duplicate implementations.  
   - Recommend consistent import patterns (absolute vs relative, path aliases) and list any required Babel/TypeScript config updates.

3. **Expert Principles & Checklist**  
   - Document “Expert Principals” (guiding rules) for managing dependencies in the Expo/Nx monorepo, including:  
     1. Prefer workspace-local installs for packages consumed directly by the app.  
     2. Keep React/React Native versions aligned across workspaces.  
     3. Use Expo’s dependency guidelines (e.g., only the versions blessed for SDK 54).  
     4. Avoid manually added symlinks; adjust package locations instead.  
   - Transform these principles into a checklist developers can run through before committing dependency changes.

4. **Action Plan**  
   - Document concrete next steps (e.g., upgrade `libs/ui` to React 19, ensure Nx/Jest tooling is installed, add scripts for dependency verification).  
   - Include testing expectations (Expo bundler, mobile Jest, Nx lint/type-check).

---

## Deliverables

- `docs/stories/1.2b.story.md` (this file).  
- Dependency inventory table (embedded in this story or referenced doc).  
- Import health summary with remediation recommendations.  
- Expert principles checklist ready for inclusion in coding standards.

---

## Suggested Tasks

1. **Task 1: Dependency Audit**  
   - [x] Run `npm ls --workspace apps/mobile --depth=1` and capture results.  
   - [ ] Compare against Expo SDK 54 dependency matrix.  
   - [x] Document mismatches in story notes.

2. **Task 2: Import Scan**  
   - [x] Use TypeScript compiler / Metro logs to list unresolved imports.  
   - [x] Record findings in Import Health section.

3. **Task 3: Expert Principles Draft**  
   - [x] Draft principles and checklist; align with architecture docs.  
   - [ ] Review with lead dev before implementation.

4. **Task 4: Action Plan**  
   - [x] Enumerate required fixes (dependency upgrades, config changes).  
   - [x] Include testing steps (Expo web, iOS/Android, Jest, Nx lint).

---

## Notes

- This story is purely diagnostic/documentation. Implementation work (library upgrades, config changes) will be tracked in follow-up stories.  
- Use this audit to prevent future “module not found” regressions while voice features evolve.

---

## Dependency Inventory Findings

- **Mobile workspace (`apps/mobile`)** – `npm ls --depth=1` shows Expo SDK 54 stack (React 19.1.0, React Native 0.81.4). Optional dependencies flagged as missing (`@expo/dom-webview`, `@expo/metro-runtime`, `react-native-webview`, `@lottiefiles/dotlottie-react`, `react-native-windows`, `immer`, `use-sync-external-store`). While optional, Zustand warns without `immer`/`use-sync-external-store`; decide whether to install or suppress warnings.  
- **Hoisting & symlinks** – `@babel/runtime` installs at repo root, and we created a manual symlink into `apps/mobile`. This is fragile; the workspace should rely on npm hoisting without manual links (or install via `expo install`).  
- **React version skew** – `libs/ui` still targets React 18 / RN 0.73, conflicting with mobile’s React 19 / RN 0.81. Importing shared UI would pull older versions.  
- **Nx toolchain** – root lists `nx@^20.3.2`, resolved to `20.8.2`. Expo app is not registered with Nx, so scripts like `nx test mobile` fail; document this to avoid confusion.  
- **Outstanding step** – still need to compare inventory against Expo SDK 54 compatibility matrix (owner: follow-up).

## Import Health Report

- `npx tsc --noEmit -p apps/mobile/tsconfig.json` fails with `TS5098` because `customConditions` is set while `moduleResolution` remains `node`. Expo recommends `moduleResolution: "bundler"`; until we update, CI cannot run TypeScript checks.  
- Recent bundler errors were caused by missing runtime dependencies (`axios`, `react-refresh`, `@babel/runtime`); after installs they resolved.  
- No remaining missing-import errors surfaced during Expo Web after dependencies were installed, but we depend on the manual `@babel/runtime` symlink—should be removed once dependency is properly installed.

## Expert Principles Checklist (Draft)

1. Install runtime dependencies with `npx expo install` whenever possible to stay aligned with SDK support.  
2. Ensure every module imported directly by the app exists in the app workspace (no manual symlinks).  
3. Keep React and React Native versions consistent across workspaces (mobile, libs/ui, libs/shared).  
4. Treat optional dependencies deliberately—either install with documented rationale or suppress warnings explicitly.  
5. Maintain Expo-friendly TypeScript settings (`moduleResolution: "bundler"`, supported compiler options) so `tsc --noEmit` runs cleanly.  
6. After dependency changes, run `npm run start:mobile` (Expo), `npx tsc --noEmit -p apps/mobile/tsconfig.json`, and lint/test commands to verify integrity.

## Action Plan

1. Update `apps/mobile/tsconfig.json` to use `moduleResolution: "bundler"` or remove `customConditions`, then wire `npx tsc --noEmit` into CI.  
2. Upgrade `libs/ui` (and any other shared packages) to React 19 / RN 0.81 or mark them inactive until updated.  
3. Remove the manual `@babel/runtime` symlink once the package is installed locally via npm (verify Expo bundler).  
4. Decide whether to install optional dependencies (`react-native-webview`, `immer`, etc.) or document why they remain absent.  
5. Clarify tooling: either register the Expo app with Nx or update documentation/scripts to use Expo commands exclusively.  
6. Add dependency verification steps (Expo bundler, `tsc`, future jest/lint) to the dev checklist.

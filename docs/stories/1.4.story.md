# Story 1.4: Core Numerology Calculation Engine

## Status
Approved

## Story
As a user,
I want to receive accurate Pythagorean numerology calculations based on my personal information,
so that I can get meaningful insights from the voicebot.

## Context
This story implements the core numerology calculation engine that powers the voicebot's ability to compute and interpret numerology numbers. This is the foundational component that enables all numerology-based insights and guidance. Users will interact with this through the voice interface that will collect their birth date and name, then display their numerology profile.

**Epic:** 1 - Foundation & Core Voice Infrastructure
**Priority:** P0 - Blocking
**Story Points:** 8
**Depends On:** Story 1.1 (completed)
**Enables:** Story 1.5 (Voice-Numerology Integration), Story 2.1 (User Personalization)

## Acceptance Criteria

1. **Life Path Number Calculation Working**
   - Life Path number accurately calculated from birth date using Pythagorean system
   - Support for all valid Life Path numbers (1-9, 11, 22, 33 Master Numbers)
   - Input validation for date format and range
   - Reduction algorithm correctly implements numerological addition rules

2. **Destiny Number Calculation Working**
   - Destiny number accurately calculated from full name using Pythagorean letter values
   - Support for Vietnamese characters and diacritical marks
   - Case-insensitive name processing
   - Correct application of Master Numbers (11, 22, 33) in reduction

3. **Soul Urge Number Calculation Working**
   - Soul Urge number calculated from vowels in full name
   - Proper identification of Vietnamese vowels (a, e, i, o, u, ơ, ư)
   - Handle compound Vietnamese vowels correctly
   - Correct numerological reduction to single digit or Master Number

4. **Personality Number Calculation Working**
   - Personality number calculated from consonants in full name
   - All consonants correctly identified (non-vowel characters)
   - Proper numerical mapping (A=1, B=2, ... Z=26 with wrapping)
   - Handle Vietnamese-specific consonants

5. **Personal Year & Month Calculations Working**
   - Personal Year calculated from birth month/day + current year
   - Personal Month calculated from birth day + current month/year
   - Both cycle through 1-9 range with proper numerological reduction
   - Update calculations daily/monthly as appropriate

6. **Numerology Interpretations Database in Vietnamese**
   - Comprehensive Vietnamese interpretations for each number
   - Separate interpretations for Life Path, Destiny, Soul Urge, Personality
   - Interpretations reflect Pythagorean numerology meanings
   - Interpretations include positive traits and growth areas
   - Support for all possible number values (1-9, 11, 22, 33)

7. **Input Validation & Error Handling**
   - Validation for birth date format and range (reasonable dates only)
   - Validation for name input (not empty, reasonable length)
   - Clear Vietnamese error messages for invalid inputs
   - Graceful handling of edge cases (missing middle names, nicknames)

## Dev Notes

### Tech Stack Context
[Source: docs/architecture/tech-stack.md v1.1 - Latest Stable January 2025]
- **Backend Language:** Python 3.13+ with full type hints
- **Backend Framework:** FastAPI 0.115 for API endpoints
- **Testing:** Pytest for numerology calculation unit tests
- **Database:** PostgreSQL 17 for storing calculated profiles
- **Data Format:** JSON for storing numerology interpretations

### Previous Story Insights
[Source: Story 1.2 & 1.3 Implementation Notes]
- Story 1.2 successfully implemented Azure OpenAI gpt-4o-mini-transcribe for Vietnamese STT (12x cost savings)
- Story 1.3 successfully implemented ElevenLabs TTS with SSML tone modulation for warm voice synthesis
- Both stories have voice services working end-to-end ready for integration
- Frontend state management uses Zustand 5.0 for clean architecture

### Core Numerology Engine Architecture
[Source: docs/architecture.md - Numerology Calculation Engine, lines 1006-1021]
**Responsibility:** Core Pythagorean numerology calculations following traditional methods

**Key Interfaces to Implement:**
- `calculateLifePath(birthDate: date) -> int`: Life Path number from date
- `calculateDestiny(fullName: str) -> int`: Destiny number from name
- `calculateSoulUrge(fullName: str) -> int`: Soul number from vowels only
- `calculatePersonality(fullName: str) -> int`: Personality number from consonants only
- `calculatePersonalYear(birthMonth: int, birthDay: int, currentYear: int) -> int`: Current year cycle
- `calculatePersonalMonth(birthDay: int, currentMonth: int, currentYear: int) -> int`: Current month cycle
- `getInterpretation(numberType: str, value: int, language: str) -> str`: Vietnamese interpretation text

**Dependencies:** None - this is pure calculation logic with no external dependencies

**Technology Stack:** Python with type hints, Vietnamese character mapping, extensive unit tests

### Data Models & Database Schema
[Source: docs/architecture.md - Data Models section, lines 237-245]

**NumerologyProfile Table:**
- `id`: UUID - Unique profile identifier
- `userId`: UUID - Foreign key to User
- `lifePathNumber`: Integer (1-9, 11, 22, 33) - Core life purpose number
- `destinyNumber`: Integer - Full name calculation result
- `soulUrgeNumber`: Integer - Vowels-based inner desire number
- `personalityNumber`: Integer - Consonants-based outer impression number
- `currentPersonalYear`: Integer - Year cycle (1-9)
- `currentPersonalMonth`: Integer - Month cycle (1-9)
- `calculatedAt`: Date - Last calculation timestamp
- `interpretations`: JSON - Cached Vietnamese interpretations as key-value pairs

**User Table (already exists from Story 1.1):**
- `fullName`: String - Full name in Vietnamese for Destiny calculation
- `birthDate`: Date - Date of birth for Life Path and timing calculations

### Pythagorean Numerology Reference
[Source: Project requirement - Pythagorean numerology system]

**Letter-to-Number Mapping (A=1 through I=9, repeating):**
- A=1, B=2, C=3, D=4, E=5, F=6, G=7, H=8, I=9, J=1, K=2, L=3, M=4, N=5, O=6, P=7, Q=8, R=9, S=1, T=2, U=3, V=4, W=5, X=6, Y=7, Z=8

**Vietnamese Vowels (for Soul Urge calculation):**
- Single: a, e, i, o, u, ơ, ư
- Compound: ai, ao, au, âu, ầu, ư, ơi, ơu, ua, uâ, uơ, ưa, ưi, ươ (handle as individual components)
- Diacritical marks: á, à, ả, ã, ạ (same vowel, different tones)

**Reduction Rules:**
- Reduce multi-digit numbers by adding digits repeatedly until single digit
- Exception: Master Numbers (11, 22, 33) typically preserved without further reduction
- For Multi-digit results: if sum > 9, add digits again (e.g., 47 → 4+7=11, keep as 11 or reduce to 2 depending on context)

**Life Path Calculation:**
- Convert birth date to digits: MM + DD + YYYY
- Add all digits together
- Reduce to single digit (except Master Numbers 11, 22, 33)
- Example: Born 03/29/1985 → 0+3+2+9+1+9+8+5 = 37 → 3+7 = 10 → 1+0 = 1 (Life Path 1)

**Destiny Number Calculation:**
- Convert each letter of full name to number using A=1...Z=8 mapping
- Sum all numbers
- Reduce to single digit (except Master Numbers)

**Soul Urge Number:**
- Extract only vowels from full name
- Convert vowels to numbers using A=1...Z=8 mapping
- Sum vowel numbers
- Reduce to single digit (except Master Numbers)

**Personality Number:**
- Extract only consonants from full name
- Convert consonants to numbers using A=1...Z=8 mapping
- Sum consonant numbers
- Reduce to single digit (except Master Numbers)

### Project Structure & File Locations
[Source: docs/architecture/source-tree.md]

**Backend Implementation:**
- Numerology engine: `libs/numerology/src/` (shared library)
- Main calculation file: `libs/numerology/src/calculator.py`
- Vietnamese mappings: `libs/numerology/src/vietnamese_mappings.py`
- Interpretations database: `libs/numerology/src/interpretations.py`
- Tests: `libs/numerology/src/__tests__/` (pytest format)

**Backend API Integration:**
- New FastAPI service: `apps/api/src/services/numerology_service.py`
- New endpoint: `POST /api/v1/numerology/profile` - accepts name and birthDate, returns full profile
- Integration with PostgreSQL: `apps/api/src/models/numerology_profile.py`

**Frontend Integration:**
- New service: `apps/mobile/src/services/numerology.ts` - API client for numerology endpoint
- Zustand store extension: `apps/mobile/src/stores/userStore.ts` - store numerology profile

### Testing Requirements
[Source: docs/architecture/coding-standards.md - Testing Strategy]

**Backend Unit Tests (Python/Pytest):**
- Test each calculation function independently
- Test Vietnamese character handling
- Test Master Number detection and preservation
- Test edge cases (empty names, invalid dates, special characters)
- Aim for 100% code coverage on calculation logic

**Test Patterns:**
```python
# Example test structure
def test_calculate_life_path_with_master_number():
    result = calculateLifePath(date(1984, 2, 20))
    assert result == 22  # Master Number preserved

def test_calculate_destiny_vietnamese():
    result = calculateDestiny("Nguyễn Văn A")
    # Verify against known calculation
    assert result in range(1, 34)  # Valid numerology number

def test_personal_year_calculation():
    # Test cycles through 1-9
    assert calculatePersonalYear(3, 15, 2025) in range(1, 10)
```

**Frontend Tests (TypeScript/Jest):**
- Test API client error handling
- Test Vietnamese error message mapping
- Test store updates when profile fetched

### Error Handling & Vietnamese Messages
[Source: docs/architecture/coding-standards.md - Error Handling]

**Validation Error Messages (Vietnamese):**
- "Ngày sinh không hợp lệ. Vui lòng nhập ngày chính xác." (Invalid birth date)
- "Tên không được để trống. Vui lòng nhập tên của bạn." (Name cannot be empty)
- "Tên quá dài. Vui lòng nhập tên ngắn hơn." (Name too long)
- "Định dạng không hợp lệ. Vui lòng kiểm tra lại." (Invalid format)

**API Error Responses:**
- 400 Bad Request: Invalid input parameters with Vietnamese error message
- 500 Internal Server Error: Calculation failure (should be rare)
- Include error codes in response for debugging

### Database Integration
[Source: docs/architecture.md - Data Persistence]

**Endpoint Design:**
```
POST /api/v1/numerology/profile
Request:
{
  "userId": "uuid",
  "fullName": "Nguyễn Văn A",
  "birthDate": "1990-03-15"
}

Response:
{
  "id": "uuid",
  "userId": "uuid",
  "lifePathNumber": 3,
  "destinyNumber": 7,
  "soulUrgeNumber": 5,
  "personalityNumber": 2,
  "currentPersonalYear": 8,
  "currentPersonalMonth": 4,
  "calculatedAt": "2025-01-16T10:30:00Z",
  "interpretations": {
    "lifePathNumber_3": "Creative expression and communication...",
    "destinyNumber_7": "Spiritual seeker and analyst..."
  }
}
```

**Caching Strategy:**
- Cache interpreted text in `interpretations` JSON field to avoid repeated lookups
- Update Personal Year/Month on daily basis
- Regenerate full profile only when user updates birth date or name

### Performance Considerations
[Source: docs/architecture.md - Performance Requirements]
- All calculations should complete in <100ms
- Aim for <500ms total API response time including DB operations
- Calculation logic should be CPU-bound only (no I/O)
- Vietnamese character processing should use efficient string operations

## Tasks / Subtasks

- [x] **Task 1: Core Pythagorean Calculation Engine** (AC: 1, 2, 3, 4, 5)
  - [x] Create `libs/numerology/src/calculator.py` with calculation functions
  - [x] Implement `calculateLifePath(birthDate)` with Master Number support
  - [x] Implement `calculateDestiny(fullName)` with A=1...Z=8 mapping
  - [x] Implement `calculateSoulUrge(fullName)` extracting vowels only
  - [x] Implement `calculatePersonality(fullName)` extracting consonants only
  - [x] Implement `calculatePersonalYear(birthMonth, birthDay, currentYear)`
  - [x] Implement `calculatePersonalMonth(birthDay, currentMonth, currentYear)`
  - [x] Add comprehensive docstrings with Pythagorean method explanation
  - [x] Handle Vietnamese characters and diacritical marks correctly

- [x] **Task 2: Vietnamese Character Mapping** (AC: 2, 3, 4)
  - [x] Create `libs/numerology/src/vietnamese_mappings.py`
  - [x] Define letter-to-number mapping (A=1...Z=8)
  - [x] Define Vietnamese vowels list including diacritical variants
  - [x] Implement vowel detection function handling compound Vietnamese vowels
  - [x] Implement consonant detection for non-vowel characters
  - [x] Add unicode normalization for consistent diacritical handling
  - [x] Unit tests for character mapping (via test_calculator.py)

- [x] **Task 3: Numerology Interpretations Database** (AC: 6)
  - [x] Create `libs/numerology/src/interpretations.py` with Vietnamese interpretations
  - [x] Define interpretation text for Life Path numbers 1-9, 11, 22, 33
  - [x] Define interpretation text for Destiny numbers 1-9, 11, 22, 33
  - [x] Define interpretation text for Soul Urge numbers 1-9, 11, 22, 33
  - [x] Define interpretation text for Personality numbers 1-9, 11, 22, 33
  - [x] Implement `getInterpretation(numberType, value, language)` function
  - [x] Ensure all interpretations reflect Pythagorean numerology principles
  - [x] Include both positive traits and growth areas in interpretations

- [ ] **Task 4: Backend FastAPI Service Implementation** (AC: 1-7)
  - [ ] Create `apps/api/src/services/numerology_service.py`
  - [ ] Create `apps/api/src/models/numerology_profile.py` for ORM model
  - [ ] Implement `POST /api/v1/numerology/profile` endpoint
  - [ ] Add input validation for birthDate and fullName
  - [ ] Call numerology calculator functions
  - [ ] Store calculated profile in PostgreSQL database
  - [ ] Return JSON response with all calculated numbers and interpretations
  - [ ] Add error handling with Vietnamese error messages
  - [ ] Type hints for all function parameters and returns

- [ ] **Task 5: Database Schema & Migrations** (AC: 1-7)
  - [ ] Create Alembic migration for NumerologyProfile table
  - [ ] Add table columns: id, userId, lifePathNumber, destinyNumber, soulUrgeNumber, personalityNumber, currentPersonalYear, currentPersonalMonth, calculatedAt, interpretations
  - [ ] Add foreign key constraint to User table
  - [ ] Add indexes for userId for efficient lookups
  - [ ] Create table with encryption settings for PII
  - [ ] Run migration and verify schema

- [ ] **Task 6: Input Validation & Error Handling** (AC: 7)
  - [ ] Implement birth date validation (valid format, reasonable date range 1900-2025)
  - [ ] Implement name validation (not empty, reasonable length < 100 chars)
  - [ ] Map validation errors to Vietnamese error messages
  - [ ] Create custom exception classes for different error types
  - [ ] Add logging for invalid inputs
  - [ ] Test edge cases: empty strings, special characters, very long names

- [ ] **Task 7: Frontend API Client Service** (AC: 1-7)
  - [ ] Create `apps/mobile/src/services/numerology.ts` TypeScript client
  - [ ] Implement `fetchNumerologyProfile(userId, fullName, birthDate)` function
  - [ ] Handle API timeout with >3 second timeout error
  - [ ] Implement retry logic with exponential backoff (max 3 attempts)
  - [ ] Parse response and return typed NumerologyProfile object
  - [ ] Map API errors to Vietnamese user-facing messages
  - [ ] Add Vietnamese error message mapping function

- [ ] **Task 8: Frontend Zustand Store Integration** (AC: 1-7)
  - [ ] Extend `apps/mobile/src/stores/userStore.ts` with numerology state
  - [ ] Add actions: `setNumerologyProfile`, `clearNumerologyProfile`, `updatePersonalYear`
  - [ ] Add state: `numerologyProfile`, `isLoadingProfile`, `profileError`
  - [ ] Implement store persistence for calculated profile
  - [ ] Add selector functions for accessing individual numbers
  - [ ] Type definitions for NumerologyProfile interface

- [ ] **Task 9: Comprehensive Unit Tests** (AC: 1-7)
  - [ ] Create `libs/numerology/src/__tests__/test_calculator.py`
  - [ ] Test Life Path calculations for known dates (with expected results)
  - [ ] Test Master Number detection (11, 22, 33)
  - [ ] Test Destiny number calculations for Vietnamese names
  - [ ] Test Soul Urge vowel extraction accuracy
  - [ ] Test Personality number consonant extraction accuracy
  - [ ] Test Personal Year calculations (cycle 1-9)
  - [ ] Test Personal Month calculations (cycle 1-9)
  - [ ] Test edge cases: single character names, all vowels, all consonants
  - [ ] Test Vietnamese special characters and diacriticals
  - [ ] Aim for 100% code coverage on calculation logic

- [ ] **Task 10: Integration Tests** (AC: 1-7)
  - [ ] Create `apps/api/src/__tests__/test_numerology_endpoint.py`
  - [ ] Test POST /api/v1/numerology/profile endpoint
  - [ ] Test database storage and retrieval
  - [ ] Test input validation error responses (400 status)
  - [ ] Test successful calculation and storage flow
  - [ ] Verify NumerologyProfile created in database
  - [ ] Test API response format matches schema
  - [ ] Test Vietnamese error messages returned correctly

- [ ] **Task 11: Frontend Integration Tests** (AC: 1-7)
  - [ ] Create `apps/mobile/src/__tests__/services/numerology.test.ts`
  - [ ] Test API client success path
  - [ ] Test API client error handling and retry logic
  - [ ] Test Vietnamese error message mapping
  - [ ] Create `apps/mobile/src/__tests__/stores/userStore.test.ts`
  - [ ] Test Zustand store state management
  - [ ] Test profile persistence

- [ ] **Task 12: Documentation & Setup** (AC: 6)
  - [ ] Document numerology calculation algorithm in code comments
  - [ ] Add docstrings to all calculation functions with examples
  - [ ] Document Vietnamese character handling approach
  - [ ] Update .env.example with any new configuration needed
  - [ ] Create `docs/numerology-calculation-guide.md` with algorithm explanation
  - [ ] Add testing instructions to developer documentation
  - [ ] Document interpretation database structure and maintenance

## Testing Strategy

**Unit Tests:**
- Calculation functions tested in isolation with known inputs/outputs
- Vietnamese character mapping tested for all vowel/consonant combinations
- Master Number detection tested comprehensively
- Error validation tested for all error paths

**Integration Tests:**
- API endpoint tested with valid and invalid inputs
- Database persistence verified
- End-to-end flow from API call to profile storage

**Manual Testing:**
- Test with various Vietnamese names and characters
- Verify calculations against known numerology references
- Test API response in mobile app
- Verify error messages display correctly in Vietnamese

**Performance Testing:**
- All calculations complete in <100ms
- API response within <500ms
- Personal Year/Month calculations perform daily correctly

## Acceptance Criteria Mapping

| AC | Related Tasks |
|---|---|
| 1. Life Path | Task 1, 2, 9 |
| 2. Destiny | Task 1, 2, 9 |
| 3. Soul Urge | Task 1, 2, 9 |
| 4. Personality | Task 1, 2, 9 |
| 5. Personal Year/Month | Task 1, 9 |
| 6. Vietnamese Interpretations | Task 3, 12 |
| 7. Input Validation | Task 6, 10 |

## Project Structure Notes

**New Directories:**
- `libs/numerology/src/` - Core numerology calculation engine
- `apps/api/src/services/` - Already exists, adding numerology_service.py
- `apps/api/src/models/` - Already exists, adding numerology_profile.py
- `apps/mobile/src/services/` - Already exists, adding numerology.ts
- `apps/mobile/src/stores/` - Already exists, extending userStore.ts

**Database:**
- New table: `NumerologyProfile` with structure defined in Dev Notes
- New migration file will be generated via Alembic

## File List

**Files Created (Tasks 1-3):**
- [x] `libs/numerology/src/__init__.py` - Library exports
- [x] `libs/numerology/src/calculator.py` - Core Pythagorean calculation functions (calculator.py, calculateLifePath, calculateDestiny, calculateSoulUrge, calculatePersonality, calculatePersonalYear, calculatePersonalMonth)
- [x] `libs/numerology/src/vietnamese_mappings.py` - Vietnamese character detection (normalize_vietnamese, get_letter_value, is_vowel, is_consonant, extract_vowels, extract_consonants)
- [x] `libs/numerology/src/interpretations.py` - Vietnamese interpretation texts for all number types (life_path, destiny, soul_urge, personality)
- [x] `libs/numerology/src/__tests__/__init__.py` - Test package init
- [x] `libs/numerology/src/__tests__/test_calculator.py` - Unit tests (37 tests, all passing)

**Files Pending (Tasks 4-12):**
- [ ] `apps/api/src/services/numerology_service.py` - FastAPI service
- [ ] `apps/api/src/models/numerology_profile.py` - SQLAlchemy ORM model
- [ ] `apps/api/src/__tests__/test_numerology_endpoint.py` - Integration tests
- [ ] `apps/mobile/src/services/numerology.ts` - Frontend API client
- [ ] `apps/mobile/src/__tests__/services/numerology.test.ts` - Client tests
- [ ] `docs/numerology-calculation-guide.md` - Algorithm documentation
- [ ] `apps/api/alembic/versions/xxx_create_numerology_profile_table.py` - Migration

**Files to Modify:**
- [ ] `apps/mobile/src/stores/userStore.ts` - Add numerology state
- [ ] `apps/mobile/src/__tests__/stores/userStore.test.ts` - Add store tests
- [ ] `.env.example` - Document any new configuration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-16 | 1.1 | Tasks 1-3 completed: Core calculation engine, Vietnamese mappings, interpretations | James (Dev) |
| 2025-01-16 | 1.0 | Initial story creation for Story 1.4 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (via Droid CLI)

### Debug Log References
- Completed task execution: `python3 -m pytest libs/numerology/src/__tests__/test_calculator.py -v` → 37 tests PASSED ✅
- All Pythagorean calculation functions tested and working with Vietnamese character support

### Completion Notes List
**Tasks 1-3 Completed:**
1. Task 1 (Core Pythagorean Calculation Engine):
   - Implemented all 6 core calculation functions with Master Number support (11, 22, 33)
   - All calculations follow Pythagorean system: A=1...Z=8 with digit reduction rules
   - Vietnamese character support integrated throughout

2. Task 2 (Vietnamese Character Mapping):
   - Implemented complete vowel detection for Vietnamese (48+ variants with diacritical marks)
   - Letter-to-number mapping (A=1 through Z=8) functional
   - Unicode NFD normalization for consistent character handling
   - Character extraction functions (vowels, consonants, letters only)

3. Task 3 (Numerology Interpretations Database):
   - Complete Vietnamese interpretation texts for all number types
   - Covers Life Path, Destiny, Soul Urge, Personality (1-9, 11, 22, 33 each)
   - getInterpretation() function with proper error handling
   - getAllInterpretations() utility function included

**Test Results:**
- 37 unit tests created and passing: 100% pass rate
- Tests cover: Single/multi-digit reduction, Master Numbers, Life Path, Destiny, Soul Urge, Personality, Personal Year/Month, Vietnamese names, edge cases

### File List
- [x] `libs/numerology/src/__init__.py` - Package exports (7 functions exported)
- [x] `libs/numerology/src/calculator.py` - 7 calculation functions, 130 lines
- [x] `libs/numerology/src/vietnamese_mappings.py` - 9 utility functions, 150 lines
- [x] `libs/numerology/src/interpretations.py` - 52 Vietnamese interpretations + 2 access functions
- [x] `libs/numerology/src/__tests__/__init__.py` - Test package init
- [x] `libs/numerology/src/__tests__/test_calculator.py` - 37 comprehensive tests

---

**Status:** Approved - Tasks 1-3 complete, ready for Task 4 (Backend FastAPI Service)
